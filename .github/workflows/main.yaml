name: Create Release and Deploy to Railway 

# trigger
on:
  push:
    branches:
    - "v[0-9]+.[0-9]+"

# Jobs in the workflow
jobs:
  # job name, 
  create_release_and_deploy:
    # OS that this job will be running on
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.event.head_commit.message, '#NORUN') }}

    # list of steps to perform task
    steps:
    - name: echo the date
      run: echo "The current time and date in GitHub is $(date)"
    - name: echo information about the context
      run: echo "head_ref - ${{ github.head_ref }}, owner - ${{ github.repository_owner }}"
    - name: List runner name
      run: echo "runner os - ${{ runner.os }}"

    - name: branch name
      run: echo "branch name - ${{ github.ref_name }}"
    - name: Checkout the current repo 
      uses: actions/checkout@v3
      with:
        ref: ${{ github.ref_name }} 
    - name: Create Release
      id: create_release
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GH_TOKEN }}
        commit: ${{ github.ref_name }}
        tag: ${{ github.ref_name }}
        name: ${{ github.ref_name }}
        draft: false
        prerelease: false
    - name: Use Node 16
      uses: actions/setup-node@v3
      with:
        node-version: 16
    - name: Install Railway
      run: npm i -g @railway/cli
    - name: Deploy
      run: railway up
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        github-token: ${{ secrets.GH_TOKEN }}

    #- name: Deploy to Railway
     # id: deployment
      #uses: bervProject/railway-deploy@0.0.7-alpha
      #env:
        #RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        #github-token: ${{ secrets.GH_TOKEN }}
    - name: Get deployment_url
      run: railway variables && VAR_A=$(railway variables | grep RAILWAY_STATIC_URL | cut -f2 -d ' ') && VAR_B=${VAR_A%?} && echo "TEMP_DEPLOYMENT_URL=$VAR_B" >> $GITHUB_ENV && cat $GITHUB_ENV
    - name: Send custom JSON data to Slack workflow
      id: slack
      uses: slackapi/slack-github-action@v1.23.0
      with:
    # For posting a rich message using Block Kit
        payload: |
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                "type": "plain_text",
                "text": "DipSA55 CI/CD Assignment Submission",
                "emoji": true
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Name:*\nYeo Min Xiu Sherlin"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Matriculation:*\nA0116582E"
                }
              ]
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Email:*\n<mailto:e1043503@u.nus.edu|e1043503@u.nus.edu>"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Repository:*\n<${{ github.repositoryUrl }}|${{ github.repositoryUrl }}>"
                }
              ]
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Deployment:*\n<https://${{ env.TEMP_DEPLOYMENT_URL }}|https://${{ env.TEMP_DEPLOYMENT_URL }}>"
                }
              ]
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "<https://${{ env.TEMP_DEPLOYMENT_URL }}|Open Application>"
                }
              ]
            } ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK